# Neural Style Memory Book - GitHub Actions Workflow
# Automated deployment to GitHub Pages with security and performance checks

name: ğŸš€ Deploy Neural Style Memory Book

on:
  # Trigger on push to main branch
  push:
    branches: [ main ]
  
  # Trigger on pull requests to main
  pull_request:
    branches: [ main ]
  
  # Allow manual triggering
  workflow_dispatch:

# Set permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # ============================================================================
  # QUALITY CHECKS JOB
  # ============================================================================
  quality-checks:
    name: ğŸ” Quality & Security Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ” Check File Structure
      run: |
        echo "ğŸ” Verifying required files exist..."
        required_files=(
          "index.html"
          "manifest.json" 
          "sw.js"
          "css/variables.css"
          "css/styles.css"
          "css/queries.css"
          "js/script.js"
        )
        
        missing_files=()
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            missing_files+=("$file")
          else
            echo "âœ… Found: $file"
          fi
        done
        
        if [ ${#missing_files[@]} -ne 0 ]; then
          echo "âŒ Missing required files:"
          printf '%s\n' "${missing_files[@]}"
          exit 1
        fi
        
        echo "ğŸ‰ All required files present!"
    
    - name: ğŸ›¡ï¸ Security Scan
      run: |
        echo "ğŸ›¡ï¸ Running security checks..."
        
        # Check for potential security issues in HTML
        if grep -r "eval\|innerHTML.*user\|document\.write" --include="*.html" --include="*.js" .; then
          echo "âš ï¸ Potential security issues found - please review"
          exit 1
        fi
        
        # Check for hardcoded secrets (basic check)
        if grep -ri "api[_-]key\|password\|secret\|token" --include="*.js" --include="*.html" .; then
          echo "âš ï¸ Potential secrets found - please review"
          exit 1
        fi
        
        echo "âœ… Basic security checks passed"
    
    - name: ğŸ“ Code Quality Check
      run: |
        echo "ğŸ“ Checking code quality..."
        
        # Check file sizes (warn if very large)
        large_files=$(find . -name "*.js" -o -name "*.css" -o -name "*.html" | xargs wc -c | awk '$1 > 500000 {print $2 " (" $1 " bytes)"}')
        if [ -n "$large_files" ]; then
          echo "âš ï¸ Large files detected:"
          echo "$large_files"
          echo "Consider minification for production"
        fi
        
        # Check for TODO/FIXME comments
        todos=$(grep -r "TODO\|FIXME" --include="*.js" --include="*.css" --include="*.html" . || true)
        if [ -n "$todos" ]; then
          echo "ğŸ“ TODOs found (informational):"
          echo "$todos"
        fi
        
        echo "âœ… Code quality check completed"

    - name: ğŸŒ Validate HTML
      run: |
        echo "ğŸŒ Validating HTML structure..."
        
        # Basic HTML validation checks
        if ! grep -q "<!DOCTYPE html>" index.html; then
          echo "âŒ Missing DOCTYPE declaration"
          exit 1
        fi
        
        if ! grep -q "<html lang=" index.html; then
          echo "âŒ Missing language attribute"
          exit 1
        fi
        
        if ! grep -q 'rel="manifest"' index.html; then
          echo "âŒ Missing PWA manifest link"
          exit 1
        fi
        
        echo "âœ… HTML validation passed"

    - name: ğŸ“± PWA Validation
      run: |
        echo "ğŸ“± Validating PWA configuration..."
        
        # Check manifest.json structure
        if ! command -v jq &> /dev/null; then
          echo "Installing jq for JSON validation..."
          sudo apt-get update && sudo apt-get install -y jq
        fi
        
        # Validate manifest.json
        if ! jq empty manifest.json; then
          echo "âŒ Invalid JSON in manifest.json"
          exit 1
        fi
        
        # Check required PWA fields
        required_fields=("name" "short_name" "start_url" "display" "icons")
        for field in "${required_fields[@]}"; do
          if ! jq -e ".$field" manifest.json > /dev/null; then
            echo "âŒ Missing required field in manifest: $field"
            exit 1
          fi
        done
        
        echo "âœ… PWA configuration valid"

  # ============================================================================
  # PERFORMANCE TESTING JOB
  # ============================================================================
  performance-test:
    name: âš¡ Performance Testing
    runs-on: ubuntu-latest
    needs: quality-checks
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm init -y
        npm install --save-dev http-server lighthouse
    
    - name: ğŸš€ Start Local Server
      run: |
        npx http-server . -p 8080 &
        echo $! > server.pid
        sleep 5
        
    - name: ğŸ” Lighthouse Audit
      run: |
        echo "ğŸ” Running Lighthouse performance audit..."
        npx lighthouse http://localhost:8080 \
          --output=json \
          --output-path=lighthouse-report.json \
          --chrome-flags="--headless --no-sandbox" \
          --only-categories=performance,accessibility,best-practices,pwa
        
        # Parse results and check thresholds
        performance_score=$(jq '.categories.performance.score * 100' lighthouse-report.json)
        accessibility_score=$(jq '.categories.accessibility.score * 100' lighthouse-report.json)
        pwa_score=$(jq '.categories.pwa.score * 100' lighthouse-report.json)
        
        echo "ğŸ“Š Lighthouse Scores:"
        echo "âš¡ Performance: ${performance_score}%"
        echo "â™¿ Accessibility: ${accessibility_score}%"
        echo "ğŸ“± PWA: ${pwa_score}%"
        
        # Set minimum thresholds
        if (( $(echo "$performance_score < 80" | bc -l) )); then
          echo "âŒ Performance score below threshold (80%)"
          exit 1
        fi
        
        if (( $(echo "$accessibility_score < 90" | bc -l) )); then
          echo "âŒ Accessibility score below threshold (90%)"
          exit 1
        fi
        
        if (( $(echo "$pwa_score < 80" | bc -l) )); then
          echo "âŒ PWA score below threshold (80%)"
          exit 1
        fi
        
        echo "âœ… All performance thresholds met!"
        
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid) || true
          rm server.pid
        fi
        
    - name: ğŸ“Š Upload Lighthouse Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-report
        path: lighthouse-report.json

  # ============================================================================
  # DEPLOYMENT JOB
  # ============================================================================
  deploy:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [quality-checks, performance-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Prepare Deployment
      run: |
        echo "ğŸ—ï¸ Preparing files for deployment..."
        
        # Create deployment directory
        mkdir -p deploy
        
        # Copy all necessary files
        cp -r css deploy/
        cp -r js deploy/
        cp index.html deploy/
        cp manifest.json deploy/
        cp sw.js deploy/
        
        # Copy documentation files
        cp README.md deploy/
        cp LICENSE deploy/
        
        # Add deployment timestamp
        echo "<!-- Deployed: $(date -u +"%Y-%m-%d %H:%M:%S UTC") -->" >> deploy/index.html
        
        echo "âœ… Deployment preparation complete"
        
    - name: ğŸ”§ Optimize for Production
      run: |
        echo "ğŸ”§ Applying production optimizations..."
        
        cd deploy
        
        # Remove development comments
        find . -name "*.js" -exec sed -i '/console\.log.*ğŸ”§.*Development/d' {} \;
        find . -name "*.js" -exec sed -i '/window\.debugApp/,+5d' {} \;
        
        # Update service worker cache name with timestamp
        timestamp=$(date +%s)
        sed -i "s/neural-style-memory-book-v1.2.0/neural-style-memory-book-v1.2.0-${timestamp}/g" sw.js
        
        echo "âœ… Production optimizations applied"
        
    - name: ğŸ“„ Setup Pages
      uses: actions/configure-pages@v4
      
    - name: ğŸ“¦ Upload Pages Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: deploy
        
    - name: ğŸš€ Deploy to Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: ğŸ‰ Deployment Success
      run: |
        echo "ğŸ‰ Deployment successful!"
        echo "ğŸŒ Site URL: ${{ steps.deployment.outputs.page_url }}"
        echo "ğŸ“Š Deployment details:"
        echo "  - Commit: ${{ github.sha }}"
        echo "  - Branch: ${{ github.ref_name }}"
        echo "  - Actor: ${{ github.actor }}"
        echo "  - Timestamp: $(date -u)"

  # ============================================================================
  # POST-DEPLOYMENT VERIFICATION
  # ============================================================================
  verify-deployment:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ğŸ” Health Check
      run: |
        echo "ğŸ” Performing post-deployment health check..."
        
        # Wait for deployment to propagate
        sleep 30
        
        # Check if site is accessible
        site_url="https://dnoice.github.io/Neural-Style-Memory-Book/"
        
        if curl -f -s "$site_url" > /dev/null; then
          echo "âœ… Site is accessible at $site_url"
        else
          echo "âŒ Site is not accessible"
          exit 1
        fi
        
        # Check if manifest is accessible
        if curl -f -s "${site_url}manifest.json" > /dev/null; then
          echo "âœ… PWA manifest is accessible"
        else
          echo "âŒ PWA manifest is not accessible"
          exit 1
        fi
        
        # Check if service worker is accessible
        if curl -f -s "${site_url}sw.js" > /dev/null; then
          echo "âœ… Service worker is accessible"
        else
          echo "âŒ Service worker is not accessible"
          exit 1
        fi
        
        echo "ğŸ‰ All health checks passed!"

  # ============================================================================
  # NOTIFICATION JOB
  # ============================================================================
  notify:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [quality-checks, performance-test, deploy, verify-deployment]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“Š Deployment Summary
      run: |
        echo "ğŸ“Š Deployment Summary for Neural Style Memory Book"
        echo "=================================================="
        echo "ğŸŒŸ Repository: ${{ github.repository }}"
        echo "ğŸ”„ Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Actor: ${{ github.actor }}"
        echo "ğŸŒ Site: https://dnoice.github.io/Neural-Style-Memory-Book/"
        echo ""
        echo "ğŸ“‹ Job Results:"
        echo "  Quality Checks: ${{ needs.quality-checks.result }}"
        echo "  Performance Test: ${{ needs.performance-test.result }}"
        echo "  Deployment: ${{ needs.deploy.result }}"
        echo "  Verification: ${{ needs.verify-deployment.result }}"
        echo ""
        echo "ğŸ• Completed: $(date -u)"
        
        if [[ "${{ needs.deploy.result }}" == "success" && "${{ needs.verify-deployment.result }}" == "success" ]]; then
          echo ""
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸš€ Your Neural Style Memory Book is live!"
        fi
